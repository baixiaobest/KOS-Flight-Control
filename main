// Main flight control loop
@lazyglobal off.
run once scheduler.
run once publish_subscribe.
run once messages.
run once thrust_attitude_control.
run once velocity_control.
run once draw_debug.

local scheduler_obj is Scheduler(). 
local pub_sub is PublishSubscribe().
local thrust_attitude_control to ThrustAttitudeControl().
local velocity_control to VelocityControl().
local draw_debug to DrawDebug().

scheduler_obj:add_module("thrust_attitude_control", thrust_attitude_control, 30).
scheduler_obj:add_module("velocity_control", velocity_control, 30).
scheduler_obj:add_module("draw_debug", draw_debug, 10).

until false {
  pub_sub:publish("velocity_setpoint", VelocitySetpointMSG(V(0, 10, 10))).
  scheduler_obj:run().
}